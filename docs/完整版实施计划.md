# 完整版权谋决战实施计划

## 项目目标
将当前15角色版本升级为完整22角色版本，支持板子系统、行动顺序、死局判定等完整功能。

## 实施阶段

### 阶段一：架构设计与数据库准备（2-3天）

#### 1.1 数据库Schema设计
**文件：`lib/db/schema.sql`**

需要修改的表：
```sql
-- rooms表扩展
ALTER TABLE rooms ADD COLUMN board_type VARCHAR(20); -- 'fate', 'balance', 'strategy', 'custom'
ALTER TABLE rooms ADD COLUMN deadlock_count INTEGER DEFAULT 0;
ALTER TABLE rooms ADD COLUMN last_state_hash TEXT;

-- players表扩展
ALTER TABLE players ADD COLUMN stored_votes INTEGER DEFAULT 0; -- 投票回收者
ALTER TABLE players ADD COLUMN vote_predictions JSONB; -- 心灵胜者预测记录
ALTER TABLE players ADD COLUMN fate_target_id INTEGER; -- 命运转移者目标
ALTER TABLE players ADD COLUMN copied_role VARCHAR(50); -- 命运复制者复制的角色
ALTER TABLE players ADD COLUMN copied_from_id INTEGER; -- 命运复制者复制的来源
ALTER TABLE players ADD COLUMN reverse_vote_used BOOLEAN DEFAULT FALSE; -- 反向投票者是否已使用
ALTER TABLE players ADD COLUMN balance_guard_used BOOLEAN DEFAULT FALSE; -- 均衡守护者是否已使用
```

需要新建的表：
```sql
-- 游戏状态历史（用于死局检测）
CREATE TABLE game_states (
    id SERIAL PRIMARY KEY,
    room_code VARCHAR(10) NOT NULL,
    round_number INTEGER NOT NULL,
    state_hash TEXT NOT NULL, -- 技能+投票的哈希值
    created_at TIMESTAMP DEFAULT NOW()
);

-- 投票预测记录（心灵胜者）
CREATE TABLE vote_predictions (
    id SERIAL PRIMARY KEY,
    room_code VARCHAR(10) NOT NULL,
    predictor_id INTEGER NOT NULL,
    predicted_player_id INTEGER NOT NULL,
    predicted_target_id INTEGER,
    round_number INTEGER NOT NULL,
    is_correct BOOLEAN,
    created_at TIMESTAMP DEFAULT NOW()
);
```

详细内容请参考实施计划文档...




