# Supabase 数据库设置指南

## 📋 步骤概览

1. 创建 Supabase 项目
2. 获取 API 密钥
3. 执行数据库 Schema
4. 配置 RLS 策略
5. 验证设置

---

## 第一步：创建 Supabase 项目

### 1. 访问 Supabase

1. 打开 https://app.supabase.com
2. 使用你的账号登录（与旧项目相同的账号）

### 2. 创建新项目

1. 点击 **"New Project"** 或 **"Create a new project"**
2. 填写项目信息：
   - **Name**: `clash-of-schemes-full`（或你喜欢的名字）
   - **Database Password**: 
     - 设置一个强密码（**重要：保存好这个密码！**）
     - 至少 12 个字符，包含大小写字母、数字
   - **Region**: 选择离你最近的区域
     - 推荐：`Southeast Asia (Singapore)` 或 `East Asia (Tokyo)`
   - **Pricing Plan**: 选择 **Free**（免费版足够开发使用）

3. 点击 **"Create new project"**
4. 等待项目创建完成（约 2-3 分钟）

---

## 第二步：获取 API 密钥

### 1. 进入项目设置

项目创建完成后，点击左侧菜单的 **Settings** → **API**

### 2. 记录以下信息

在 **Project API keys** 部分，你会看到：

#### ✅ Project URL
```
格式：https://xxxxx.supabase.co
```
这就是 `NEXT_PUBLIC_SUPABASE_URL`

#### ✅ anon public key
```
格式：eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```
这就是 `NEXT_PUBLIC_SUPABASE_ANON_KEY`

#### ✅ service_role key
```
格式：eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```
⚠️ **重要**：这就是 `SUPABASE_SERVICE_KEY`，**不要暴露给客户端！**

### 3. 复制密钥

将这三个值复制到安全的地方（例如记事本），稍后会用到。

---

## 第三步：执行数据库 Schema

### 1. 打开 SQL Editor

1. 在 Supabase Dashboard 左侧菜单，点击 **SQL Editor**
2. 点击 **"New query"** 创建新查询

### 2. 执行 Schema 文件

1. 打开项目中的 `lib/db/schema.sql` 文件
2. **复制所有内容**（Ctrl+A, Ctrl+C）
3. 粘贴到 Supabase SQL Editor 中
4. 点击 **"Run"** 或按 `Ctrl+Enter` 执行

### 3. 验证执行结果

应该看到：
```
Success. No rows returned
```

如果看到错误，检查：
- 是否已经存在某些表（可以删除后重新执行）
- SQL 语法是否正确

### 4. 检查表是否创建成功

在左侧菜单点击 **Table Editor**，应该看到以下表：
- ✅ rooms
- ✅ players
- ✅ votes
- ✅ night_actions
- ✅ game_logs
- ✅ game_states
- ✅ vote_predictions

---

## 第四步：配置 RLS 策略

### 1. 执行 RLS 策略文件

1. 在 SQL Editor 中，点击 **"New query"**
2. 打开项目中的 `lib/db/rls-policies.sql` 文件
3. **复制所有内容**
4. 粘贴到 SQL Editor 中
5. 点击 **"Run"** 执行

### 2. 验证策略

在左侧菜单点击 **Authentication** → **Policies**，应该看到各个表的策略。

---

## 第五步：更新环境变量

### 1. 编辑 .env.local

在项目目录中，打开 `.env.local` 文件，填入你的 Supabase 配置：

```env
NEXT_PUBLIC_SUPABASE_URL=https://你的项目id.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=你的anon_key
SUPABASE_SERVICE_KEY=你的service_role_key
```

### 2. 验证配置

保存文件后，重启开发服务器（如果正在运行）：

```powershell
# 停止当前服务器 (Ctrl+C)
# 重新启动
npm run dev
```

---

## 第六步：测试数据库连接

### 1. 创建测试房间

在浏览器打开 http://localhost:3000，尝试：
1. 输入名字
2. 点击"创建房间"
3. 检查是否成功创建

### 2. 检查数据库

在 Supabase Dashboard → **Table Editor** → **rooms**，应该能看到新创建的房间。

---

## ✅ 数据库设置完成检查清单

- [ ] Supabase 项目已创建
- [ ] 已记录 Project URL
- [ ] 已记录 anon public key
- [ ] 已记录 service_role key
- [ ] 已执行 `schema.sql`
- [ ] 已执行 `rls-policies.sql`
- [ ] 所有表都已创建
- [ ] `.env.local` 已配置
- [ ] 测试创建房间成功

---

## 🆘 常见问题

### Q: 执行 SQL 时出错？

**A**: 
1. 检查是否已经存在表（可以先删除）
2. 确保 SQL 语法正确
3. 检查是否有权限错误

### Q: 找不到 API keys？

**A**: 
1. 确保在正确的项目中
2. 点击 Settings → API
3. 如果看不到，检查项目是否已完全创建

### Q: 连接数据库失败？

**A**: 
1. 检查 `.env.local` 中的 URL 和 Key 是否正确
2. 确保没有多余的空格
3. 重新启动开发服务器

### Q: RLS 策略导致无法访问？

**A**: 
- 这是正常的，客户端只能读取
- 所有写操作都通过 API 路由（使用 Service Role Key）

---

## 📝 重要提示

1. **保存好密码和密钥**
   - Database Password：用于直接连接数据库
   - Service Role Key：用于服务端操作，不要暴露

2. **不要提交 .env.local**
   - 文件已在 `.gitignore` 中
   - 不要将密钥提交到 GitHub

3. **生产环境配置**
   - 在 Vercel 中配置相同的环境变量
   - 不要使用开发环境的密钥

---

**数据库设置完成！接下来配置 Vercel 部署。** 🎉



