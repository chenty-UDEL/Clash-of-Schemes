# 数据库错误修复指南

## ❌ 错误信息

```
Error: Failed to run sql query: ERROR: 42P01: relation "rooms" does not exist
```

## 🔍 错误原因

这个错误表示在执行 RLS 策略时，`rooms` 表还没有被创建。

**可能的原因**：
1. 先执行了 `rls-policies.sql`，但还没有执行 `schema.sql`
2. `schema.sql` 执行失败
3. 执行顺序错误

## ✅ 解决方案

### 方案一：使用合并的初始化脚本（推荐）

我已经创建了一个完整的初始化脚本 `lib/db/init.sql`，它会按正确顺序执行所有操作。

**步骤**：

1. **在 Supabase SQL Editor 中**，点击 **"New query"**

2. **打开项目中的 `lib/db/init.sql` 文件**，复制所有内容

3. **粘贴到 SQL Editor 中**

4. **点击 "Run" 执行**

这个脚本会：
- ✅ 先创建所有表
- ✅ 然后创建索引
- ✅ 然后创建触发器
- ✅ 最后配置 RLS 策略

### 方案二：按正确顺序分别执行

如果你已经执行了部分 SQL，可以按以下顺序重新执行：

#### 1. 先执行 schema.sql

1. 在 SQL Editor 中，点击 **"New query"**
2. 打开 `lib/db/schema.sql`，复制所有内容
3. 粘贴并执行
4. 确认所有表已创建（在 Table Editor 中查看）

#### 2. 再执行 rls-policies.sql

1. 在 SQL Editor 中，点击 **"New query"**
2. 打开 `lib/db/rls-policies.sql`，复制所有内容
3. 粘贴并执行

### 方案三：清理后重新执行

如果表已经部分创建，可以清理后重新执行：

```sql
-- 删除所有表（谨慎操作！会删除所有数据）
DROP TABLE IF EXISTS vote_predictions CASCADE;
DROP TABLE IF EXISTS game_states CASCADE;
DROP TABLE IF EXISTS game_logs CASCADE;
DROP TABLE IF EXISTS night_actions CASCADE;
DROP TABLE IF EXISTS votes CASCADE;
DROP TABLE IF EXISTS players CASCADE;
DROP TABLE IF EXISTS rooms CASCADE;

-- 然后执行 init.sql
```

## 📋 验证步骤

执行完成后，验证：

1. **检查表是否创建**
   - 在 Supabase Dashboard → **Table Editor**
   - 应该看到 7 个表：
     - ✅ rooms
     - ✅ players
     - ✅ votes
     - ✅ night_actions
     - ✅ game_logs
     - ✅ game_states
     - ✅ vote_predictions

2. **检查 RLS 策略**
   - 在 Supabase Dashboard → **Authentication** → **Policies**
   - 应该看到各个表的策略

3. **测试创建房间**
   - 在本地运行 `npm run dev`
   - 尝试创建房间
   - 检查数据库是否有数据

## 🆘 如果还是出错

### 检查错误信息

在 SQL Editor 中查看详细的错误信息，常见错误：

1. **表已存在**
   ```
   ERROR: relation "rooms" already exists
   ```
   - 解决：使用 `DROP TABLE` 删除后重新创建，或使用 `CREATE TABLE IF NOT EXISTS`

2. **权限错误**
   ```
   ERROR: permission denied
   ```
   - 解决：确保使用正确的数据库用户

3. **语法错误**
   ```
   ERROR: syntax error
   ```
   - 解决：检查 SQL 语法，确保所有引号、括号匹配

### 获取帮助

如果问题持续：
1. 复制完整的错误信息
2. 检查 Supabase Dashboard 的日志
3. 查看 Supabase 文档

## ✅ 推荐做法

**使用 `init.sql` 文件**，因为：
- ✅ 按正确顺序执行所有操作
- ✅ 包含错误处理（IF NOT EXISTS, DROP IF EXISTS）
- ✅ 一次性完成所有设置
- ✅ 可以重复执行（不会出错）

---

**现在使用 `lib/db/init.sql` 重新执行即可！** 🚀



