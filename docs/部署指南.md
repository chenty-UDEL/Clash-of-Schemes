# 部署指南

## 一、Supabase数据库设置

### 1. 创建新项目

1. 访问 [Supabase Dashboard](https://app.supabase.com)
2. 点击 "New Project"
3. 填写项目信息：
   - **Name**: `clash-of-schemes-full` (或你喜欢的名字)
   - **Database Password**: 设置强密码（保存好）
   - **Region**: 选择离你最近的区域
4. 等待项目创建完成（约2分钟）

### 2. 获取API密钥

1. 进入项目后，点击左侧 **Settings** → **API**
2. 记录以下信息：
   - **Project URL**: 这就是 `NEXT_PUBLIC_SUPABASE_URL`
   - **anon public key**: 这就是 `NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - **service_role key**: 这就是 `SUPABASE_SERVICE_KEY`（⚠️ 保密！）

### 3. 执行数据库Schema

1. 点击左侧 **SQL Editor**
2. 打开项目中的 `lib/db/schema.sql` 文件
3. 复制所有SQL语句
4. 粘贴到SQL Editor中
5. 点击 **Run** 执行

### 4. 配置Row Level Security (RLS)

执行 `lib/db/rls-policies.sql` 中的RLS策略（如果提供）

## 二、GitHub仓库设置

### 1. 创建新仓库

1. 访问 [GitHub](https://github.com)
2. 点击右上角 **+** → **New repository**
3. 填写信息：
   - **Repository name**: `quan-mou-jue-zhan-full` (或你喜欢的名字)
   - **Description**: "权谋决战完整版 - 22角色社交推理游戏"
   - **Visibility**: Public 或 Private（根据你的需求）
4. 点击 **Create repository**

### 2. 初始化并推送代码

在项目目录中执行：

```bash
# 初始化Git
git init

# 添加所有文件
git add .

# 提交
git commit -m "Initial commit: 完整版项目初始化"

# 添加远程仓库（替换为你的仓库URL）
git remote add origin https://github.com/your-username/quan-mou-jue-zhan-full.git

# 推送代码
git branch -M main
git push -u origin main
```

## 三、Vercel部署

### 1. 导入项目

1. 访问 [Vercel Dashboard](https://vercel.com)
2. 点击 **Add New...** → **Project**
3. 选择你刚创建的GitHub仓库
4. 点击 **Import**

### 2. 配置项目

1. **Project Name**: `quan-mou-jue-zhan-full` (或你喜欢的名字)
2. **Framework Preset**: Next.js (应该自动检测)
3. **Root Directory**: `./` (默认)
4. **Build Command**: `npm run build` (默认)
5. **Output Directory**: `.next` (默认)

### 3. 配置环境变量

在 **Environment Variables** 部分，添加以下变量：

```
NEXT_PUBLIC_SUPABASE_URL = <你的Supabase URL>
NEXT_PUBLIC_SUPABASE_ANON_KEY = <你的anon key>
SUPABASE_SERVICE_KEY = <你的service_role key>
```

⚠️ **重要**：
- `NEXT_PUBLIC_` 前缀的变量会暴露给客户端
- `SUPABASE_SERVICE_KEY` 不会暴露给客户端（没有NEXT_PUBLIC_前缀）
- 确保所有环境（Production, Preview, Development）都配置了这些变量

### 4. 部署

1. 点击 **Deploy**
2. 等待部署完成（约2-3分钟）
3. 部署成功后，你会得到一个URL，例如：
   - `quan-mou-jue-zhan-full.vercel.app`

### 5. 自定义域名（可选）

1. 在Vercel项目设置中，点击 **Domains**
2. 输入你的域名（例如：`clash-of-schemes.com`）
3. 按照提示配置DNS记录
4. 等待DNS生效（通常几分钟到几小时）

## 四、验证部署

### 1. 访问网站

打开Vercel提供的URL，检查网站是否正常加载。

### 2. 测试功能

1. 创建房间
2. 加入房间
3. 开始游戏
4. 测试基本功能

### 3. 检查数据库连接

在浏览器开发者工具的Console中，检查是否有Supabase连接错误。

## 五、环境变量清单

### 开发环境 (`.env.local`)

```env
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 生产环境 (Vercel)

在Vercel Dashboard中配置相同的变量。

## 六、常见问题

### Q: 部署后出现数据库连接错误？

A: 检查：
1. 环境变量是否正确配置
2. Supabase项目是否正常运行
3. RLS策略是否允许访问

### Q: 如何更新代码？

A: 
1. 在本地修改代码
2. 提交并推送到GitHub
3. Vercel会自动检测并重新部署

### Q: 如何回滚到之前的版本？

A: 在Vercel Dashboard的 **Deployments** 中，可以查看历史版本并重新部署。

### Q: 如何查看日志？

A: 在Vercel Dashboard的 **Functions** 或 **Deployments** 中查看日志。

## 七、安全建议

1. **不要**将 `.env.local` 提交到Git
2. **不要**在客户端代码中使用 `SUPABASE_SERVICE_KEY`
3. **确保**配置了RLS策略，限制数据库访问
4. **定期**更新依赖包，修复安全漏洞
5. **使用**HTTPS（Vercel自动提供）

## 八、性能优化

1. 启用Vercel的CDN缓存
2. 优化数据库查询（添加索引）
3. 使用Next.js的Image组件优化图片
4. 启用代码分割和懒加载

## 支持

如有问题，请提交Issue或联系维护者。


